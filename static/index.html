<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AriaClaw</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #1a1a2e;
    color: #e0e0e0;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    background: #16213e;
    border-bottom: 1px solid #0f3460;
  }
  header h1 { font-size: 18px; font-weight: 600; color: #e94560; }
  .status-dots { display: flex; gap: 16px; }
  .status-dot {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: #888;
  }
  .status-dot .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #555;
    transition: background 0.3s;
  }
  .status-dot .dot.connected { background: #4caf50; }
  .status-dot .dot.connecting { background: #ff9800; }
  .status-dot .dot.error { background: #f44336; }

  .main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  .video-panel {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #0a0a1a;
    min-width: 0;
  }
  .video-panel img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }
  .video-placeholder {
    color: #444;
    font-size: 14px;
  }

  .sidebar {
    width: 380px;
    display: flex;
    flex-direction: column;
    border-left: 1px solid #0f3460;
    background: #16213e;
  }
  .sidebar-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }
  .sidebar-section + .sidebar-section {
    border-top: 1px solid #0f3460;
  }
  .sidebar-header {
    padding: 10px 16px;
    font-size: 13px;
    font-weight: 600;
    color: #888;
    border-bottom: 1px solid #0f3460;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    flex-shrink: 0;
  }
  .sidebar-list {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .transcript-item {
    font-size: 13px;
    line-height: 1.5;
    padding: 6px 0;
  }
  .transcript-item .role {
    font-weight: 600;
    margin-right: 6px;
  }
  .transcript-item .role.user { color: #64b5f6; }
  .transcript-item .role.model { color: #81c784; }
  .transcript-item .role.tool { color: #ffb74d; }

  .context-item {
    font-size: 12px;
    line-height: 1.4;
    padding: 4px 0;
    display: flex;
    gap: 8px;
    align-items: flex-start;
  }
  .context-item .ctx-icon { flex-shrink: 0; width: 16px; text-align: center; }
  .context-item .ctx-time { color: #666; font-size: 11px; flex-shrink: 0; }
  .context-item .ctx-text { color: #ccc; }

  footer {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 12px 20px;
    background: #16213e;
    border-top: 1px solid #0f3460;
  }
  button {
    padding: 8px 24px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  button:hover { opacity: 0.85; }
  button:disabled { opacity: 0.4; cursor: not-allowed; }
  #startBtn { background: #4caf50; color: white; }
  #stopBtn { background: #f44336; color: white; }
</style>
</head>
<body>
  <header>
    <h1>AriaClaw</h1>
    <div class="status-dots">
      <div class="status-dot">
        <span class="dot" id="ariaDot"></span>
        <span>Aria</span>
      </div>
      <div class="status-dot">
        <span class="dot" id="geminiDot"></span>
        <span>Gemini</span>
      </div>
      <div class="status-dot">
        <span class="dot" id="openclawDot"></span>
        <span>OpenClaw</span>
      </div>
    </div>
    <div id="hrDisplay" style="margin-left:auto; margin-right:16px; font-size:14px; color:#666; display:none;">
      <span style="color:#e57373;">&hearts;</span> <span id="hrValue">--</span> bpm
    </div>
  </header>

  <div class="main">
    <div class="video-panel">
      <img id="videoFeed" alt="Live Feed" style="display:none;">
      <div class="video-placeholder" id="videoPlaceholder">No video feed</div>
    </div>
    <div class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-header">Transcription</div>
        <div class="sidebar-list" id="transcriptList"></div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-header">Context</div>
        <div class="sidebar-list" id="contextList"></div>
      </div>
    </div>
  </div>

  <footer>
    <button id="startBtn" onclick="sendCommand('start')">Start Session</button>
    <button id="stopBtn" onclick="sendCommand('stop')" disabled>Stop Session</button>
  </footer>

<script>
const transcriptList = document.getElementById('transcriptList');
const contextList = document.getElementById('contextList');

const CONTEXT_ICONS = {
  scene_change: '\u{1F4F7}',
  speech_self: '\u{1F3A4}',
  speech_other: '\u{1F3A4}',
  location_change: '\u{1F4CD}',
  heart_rate_spike: '\u{2764}\u{FE0F}',
  activity_change: '\u{1F6B6}',
  text_detected: '\u{1F4DD}',
};
const videoFeed = document.getElementById('videoFeed');
const videoPlaceholder = document.getElementById('videoPlaceholder');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');

let ws = null;
let sessionActive = false;

function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);

  ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);

    if (msg.type === 'status') {
      updateDot('ariaDot', msg.aria);
      updateDot('geminiDot', msg.gemini);
      updateDot('openclawDot', msg.openclaw);

      // Show video when streaming
      if (msg.aria === 'streaming') {
        if (!videoFeed.src || !videoFeed.src.endsWith('/video')) {
          videoFeed.src = '/video';
        }
        videoFeed.style.display = 'block';
        videoPlaceholder.style.display = 'none';
      } else {
        videoFeed.style.display = 'none';
        videoPlaceholder.style.display = '';
        videoFeed.removeAttribute('src');
      }
    }

    if (msg.type === 'transcript') {
      addTranscript(msg.role, msg.text);
    }

    if (msg.type === 'tool_call') {
      addTranscript('tool', '⚡ ' + msg.data);
    }

    if (msg.type === 'tool_result') {
      addTranscript('tool', '→ ' + msg.data);
    }

    if (msg.type === 'context_event') {
      addContextEvent(msg.event_type, msg.content, msg.timestamp);
    }

    if (msg.type === 'heart_rate') {
      document.getElementById('hrDisplay').style.display = '';
      document.getElementById('hrValue').textContent = msg.bpm;
    }
  };

  ws.onclose = () => {
    setTimeout(connectWS, 2000);
  };
}

function updateDot(id, state) {
  const dot = document.getElementById(id);
  dot.className = 'dot';
  if (['streaming', 'ready', 'connected'].includes(state)) {
    dot.classList.add('connected');
  } else if (['connecting', 'setting_up', 'checking'].includes(state)) {
    dot.classList.add('connecting');
  } else if (['error', 'unreachable'].includes(state)) {
    dot.classList.add('error');
  }
}

let lastTranscriptRole = null;
let lastTranscriptEl = null;
let lastTranscriptText = '';

function addTranscript(role, text) {
  // Append to existing line if same role (streaming word-by-word)
  if (role === lastTranscriptRole && lastTranscriptEl && (role === 'user' || role === 'model')) {
    lastTranscriptText += text;
    const label = role === 'user' ? 'You' : 'AI';
    lastTranscriptEl.innerHTML = `<span class="role ${role}">${label}:</span>${escapeHtml(lastTranscriptText)}`;
    transcriptList.scrollTop = transcriptList.scrollHeight;
    return;
  }

  // New line for different role or tool events
  const item = document.createElement('div');
  item.className = 'transcript-item';

  let label = 'System';
  if (role === 'user') label = 'You';
  else if (role === 'model') label = 'AI';
  else if (role === 'tool') label = 'Tool';

  item.innerHTML = `<span class="role ${role}">${label}:</span>${escapeHtml(text)}`;
  transcriptList.appendChild(item);
  transcriptList.scrollTop = transcriptList.scrollHeight;

  if (role === 'user' || role === 'model') {
    lastTranscriptRole = role;
    lastTranscriptEl = item;
    lastTranscriptText = text;
  } else {
    lastTranscriptRole = null;
    lastTranscriptEl = null;
    lastTranscriptText = '';
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function addContextEvent(eventType, content, timestamp) {
  const item = document.createElement('div');
  item.className = 'context-item';

  const icon = CONTEXT_ICONS[eventType] || '\u{2139}\u{FE0F}';
  const time = timestamp ? new Date(timestamp).toLocaleTimeString() : '';

  let description = '';
  if (eventType === 'scene_change') {
    description = content.description || 'Scene changed';
  } else if (eventType === 'speech_self') {
    description = 'You: ' + (content.text || '');
  } else if (eventType === 'speech_other') {
    description = 'Other: ' + (content.text || '');
  } else if (eventType === 'location_change') {
    description = content.description || 'Location changed';
  } else if (eventType === 'heart_rate_spike') {
    description = 'HR spike: ' + (content.heart_rate || '') + ' bpm (baseline ' + (content.baseline || '') + ')';
  } else if (eventType === 'activity_change') {
    description = content.activity || 'Activity changed';
  } else if (eventType === 'text_detected') {
    description = content.text || 'Text detected';
  } else {
    description = eventType + ': ' + JSON.stringify(content);
  }

  item.innerHTML =
    '<span class="ctx-icon">' + icon + '</span>' +
    '<span class="ctx-time">' + escapeHtml(time) + '</span>' +
    '<span class="ctx-text">' + escapeHtml(description) + '</span>';
  contextList.appendChild(item);
  contextList.scrollTop = contextList.scrollHeight;
}

function sendCommand(cmd) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({command: cmd}));
    if (cmd === 'start') {
      sessionActive = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
    } else {
      sessionActive = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }
  }
}

connectWS();
</script>
</body>
</html>
